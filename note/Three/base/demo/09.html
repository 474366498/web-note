<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<style>
  body{
    margin:0;
  }
</style>
<body>
  
</body>

<script type="importmap">
  
  {
    "imports" : {
      "three" : "../../three/build/three.module.js" ,
      "plugins/":"../../three/jsm/"
    }
  }
</script>

<script type="module">
  import * as T from 'three' 
  import { OrbitControls } from 'plugins/controls/OrbitControls.js'
  import { EffectComposer  } from "plugins/postprocessing/EffectComposer.js";
  import { RenderPass  } from "plugins/postprocessing/RenderPass.js";
  import { OutlinePass } from 'plugins/postprocessing/OutlinePass.js'
  import { ShaderPass } from 'plugins/postprocessing/ShaderPass.js'
  import { FXAAShader } from 'plugins/shaders/FXAAShader.js'


  console.log(T , OrbitControls , OutlinePass);

  const scene = new T.Scene() 

  for(let i = 0 ; i < 5;i++) {
    let group = new T.Group()
    group.name = `group-${i+1}` 
    for(let j = 0;j < 6; j++) {
      let geo = j % 2 === 0 ? new T.BoxGeometry(50,50,50) : new T.CylinderGeometry(30,50,50,24) 
      let material = new T.MeshLambertMaterial({
        color : j % 2 === 0 ? 0xff0000 : 0xffff00
      })
      let mesh = new T.Mesh(geo,material) 
      mesh.name = `mesh-${j+1}` 
      mesh.position.set(j*100 + 25 ,50 ,i*100 + 50)
      group.add(mesh)
    }
    scene.add(group)
  }
  
  const spot = new T.SpotLight(0xffffff) 
  spot.position.set(600,600,500)
  const targetObj = new T.Object3D()
  targetObj.position.set(300,0,250)
  console.log(55,targetObj)
  spot.target = targetObj
  // spot.angle = Math.PI/2
  scene.add(spot) 
  
  const spotHelper = new T.SpotLightHelper(spot)
  scene.add(spotHelper)



  const axes = new T.AxesHelper(1e3) 
  scene.add(axes) 

  const camera = new T.PerspectiveCamera(45,window.innerWidth / window.innerHeight ,.1 , 3e3) 
  camera.position.set(5e2,5e2,5e2) 
  camera.lookAt(0,0,0) 

  const webgl = new T.WebGLRenderer({antialias:true }) 
  webgl.setSize(window.innerWidth , window.innerHeight)
  webgl.setClearColor(0x444444) 
  webgl.setPixelRatio(window.devicePixelRatio)

  webgl.render(scene,camera) 
  console.log(webgl , scene)
  document.body.appendChild(webgl.domElement)
  webgl.domElement.addEventListener('click',domElementClick,true) 

  let flg = true
  wiggle()
  function wiggle (){
    if(spot.angle > Math.PI / 2) {
      flg = false 
    }else if(spot.angle <= 0){
      flg = true
    }
    if(flg) {
      spot.angle += Math.PI / 360
    }else{
      spot.angle -= Math.PI / 360
    }
    // console.log(spot.angle)
    spotHelper.update()
    webgl.render(scene,camera)
    requestAnimationFrame(wiggle)
  }


  var nameNode , faguang = false 
  var composer , renderPass
  function domElementClick(event) {
    let raycaster = new T.Raycaster() 
    let mouse = new T.Vector2()
    mouse.x = (event.clientX / window.innerWidth) * 2 - 1 
    mouse.y = -(event.clientY / window.innerHeight) * 2 + .8 

    raycaster.setFromCamera(mouse,camera) 

    const intersects = raycaster.intersectObjects(scene.children) 

    console.log(112,intersects)
    if(!intersects.length) return 
    if(nameNode == intersects[0].object) {
      faguang = !faguang
    }else{
      faguang = false
    }
    nameNode = intersects[0].object

    outlineObj(intersects[0].object)

  }
  function outlineObj (obj) {
    composer = new EffectComposer(webgl)
    renderPass = new RenderPass(scene,camera)
    composer.addPass(renderPass)
    let outlinePass = new OutlinePass(new T.Vector2(window.innerWidth,window.innerHeight),scene,camera,obj)
    console.log(outlinePass)
    outlinePass.edgeStrength = 15
    outlinePass.edgeGlow = 2 
    outlinePass.usePatternTexture = false 
    outlinePass.edgeThickness = 1 
    outlinePass.downSampleRatio = 1 
    outlinePass.pulsePeriod = 0 
    outlinePass.visibleEdgeColor.set(parseInt(0x000000)) 
    outlinePass.hiddenEdgeColor = new T.Color(0xff0000) 
    outlinePass.clear = true
    composer.addPass(outlinePass)
    let effectFXAA = new ShaderPass(FXAAShader)
    effectFXAA.uniforms.resolution.value.set(1/window.innerWidth , 1/window.innerHeight)
    effectFXAA.renderToScreen = true 
    composer.addPass(effectFXAA)
    console.log(composer)
  }



  const orbit = new OrbitControls(camera,webgl.domElement)
  orbit.addEventListener('change',()=>{
    webgl.render(scene,camera)
  })

  scene.traverse(function (item) {
    // console.log(103,item,'场景',item.isScene, '组合',item.isGroup,'网格',item.isMesh,'name',item.name)
    let v3Position = new T.Vector3() 
    item.getWorldPosition(v3Position)
    // console.log(106,'worldPosition',v3Position)
    // console.log(item,item instanceof T.Mesh,item.isMesh)
  })

</script>

</html>