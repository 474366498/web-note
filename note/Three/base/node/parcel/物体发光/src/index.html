<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <title>Document</title>
    <link rel="stylesheet" href="./style.css" />
    <script src="./world.js"></script>
  </head>
  <body></body>
  <!-- <script type="module" src="./main/index.js"> </script> -->
  <!-- <script type="module" src="./main/outline.js"> </script> -->
  <!-- <script type="module" src="./main/afterimage.js"> </script> -->
  <!-- <script type="module" src="./main/advanced.js"> </script> -->
  <!-- <script type="module" src="./main/window-scene.js"> </script>  -->

  <!-- <script type="module" src="./main/backgrounds.js"> </script>  -->

  <!-- <script type="module" src="./main/crossfade.js"> </script> -->
  <!-- <script type="module" src="./main/dof2.js"> </script> -->
  <!-- <script type="module" src="./main/glitch.js"> </script> -->

  <!-- <script type="module" src="./main/birds.js"> </script> -->
  <!-- <script type="module" src="./main/animation_keyframes.js"> </script> -->
  <!-- <script type="module" src="./main/threeMap.js"></script> -->
  <!-- <script type="module" src="./main/animate_multiple.js"></script> -->

  <!-- <script type="module" src="./main/animate_skinning_morph.js"></script> -->
  <!-- <script type="module" src="./main/animate_skinning_ik.js"></script> -->

  <!-- <script type="module" src="./main/animate_skinning_blending.js"></script> -->

  <!-- <script  type="module"  src="./main/animate_skinning_additive_blending.js" ></script> -->

  <!-- <script type="module" src="./main/camera_array.js"></script> -->

  <!-- <script type="module" src="./main/camera_cinematic.js"></script> -->

  <!-- <script type="module" src="./main/camera_logarithmicdepthbuffer.js"></script> -->

  <!-- <script type="module" src="./main/clipping.js"></script> -->

  <!-- <script type="module" src="./main/webgl-christmas.js"></script> -->

  <!-- <script type="module" src="./main/css2d.js"></script> -->

  <!-- <script type="module" src="./main/css3_sprites.js"></script> -->

  <!-- <script type="module" src="./main/css3_modecules.js"></script> -->

  <!-- <script type="module" src="./main/css3_orthographic.js"></script> -->

  <!-- <script type="module" src="./main/css3_periodictable.js"></script> -->

  <!-- <script type="module" src="./main/css3.js"></script> -->
  <!-- <script type="module" src="./main/IndexDBCache.js"></script> -->

  <!-- <script type="module" src="./main/webgl_clipping_advanced.js"></script> -->

  <!-- <script type="module" src="./main/webgl_clipping_intersection.js"></script> -->

  <!-- <script type="module" src="./main/webgl_clipping_stencil.js"></script> -->

  <!-- <script type="module" src="./main/webgl_decals.js"></script> -->

  <!-- <script type="module" src="./main/webgl_effects_anaglyph.js"></script> -->

  <!-- <script type="module" src="./main/webgl_effects_ascii.js"></script> -->

  <!-- <script type="module" src="./main/webgl_framebuffer_texture.js"></script> -->

  <!-- <script type="module" src="./main/webgl_geometries.js"></script> -->

  <script type="module" src="./main/webgl_geometries_parametric.js"></script>

  <script type="text/javascript">
    // ws://47.108.226.58:8081/webSocket/

    class WebSocketClass {
      constructor(params) {
        this.lock = params.lock
        this.url = params.url
        this.callback = params.callback || null
        this.userClose = false
        this.time = params.time || 5e3
        this.createWebSocket()
        this.webSocketState = false
        this.params = params
      }

      createWebSocket() {
        let _this = this

        if (typeof WebSocket !== 'function') {
          console.error(
            '您的浏览器不支持Websocket通信协议，请更换浏览器为Chrome或者Firefox再次使用！'
          )
          return false
        }

        try {
          this.ws = new WebSocket(_this.url)
          this.initEventHandle()
          this.startHeartBeat()
        } catch (error) {
          this.reconnect()
        }
      }
      // 重连
      reconnect() {
        let _this = this
        if (_this.lock) return
        this.lock = true

        setTimeout(() => {
          _this.createWebSocket()
          _this.params.openSuccess && _this.params.openSuccess(_this)
          _this.params.getSocketMsg && _this.params.getWebSocketMsg(_this)
        }, 3 * _this.time)
      }

      initEventHandle() {
        const _this = this
        const { ws } = this
        console.log(66, ws, this)
        ws.onopen = function() {
          console.log('websocket连接成功', this)
        }

        ws.onclose = function() {
          console.log(70, _this)
          if (!_this.userClose) {
            _this.reconnect()
          }
        }

        ws.onerror = function() {
          console.log(76, _this)
          if (!_this.userClose) {
            _this.reconnect()
          }
        }

        ws.onmessage = function(event) {
          console.log(96, _this)
          _this.getWebSocketMsg(_this.callback)
        }
      }

      startHeartBeat() {
        // const _this = this
        console.log(102, 'heart')
        setTimeout(() => {
          let params = {
            request: 'ping'
          }
          this.webSocketSendMsg(JSON.stringify(params))
          this.waitingServer()
        }, this.time)
      }
      webSocketSendMsg(msg) {
        console.log(113, this.ws, msg)
        this.ws.send(msg)
      }

      getWebSocketMsg(callback) {
        console.log(116, callback)
        this.ws.onmessage = event => {
          callback && callback(event)
        }
      }

      waitingServer() {
        this.webSocketState = false
        setTimeout(() => {
          if (this.webSocketState) {
            this.startHeartBeat()
            return
          }
          try {
            this.closeSocket()
          } catch (e) {
            console.warn('连接已关闭，无需关闭', new Date().toLocaleString())
          }
          this.reconnect()
        }, this.time)
      }
    }

    // let ws = new WebSocketClass({
    //   url: 'ws://47.108.226.58:8081/webSocket/afd00d061247436faeb881fa3c4159c6',
    //   callback: function(msg) {
    //     console.log(141, msg.data)
    //   }
    // })
    // setTimeout(() => {
    //   ws.webSocketSendMsg('123')
    // }, 5e3)
  </script>
</html>
